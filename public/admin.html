<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="../styles/admin.css">
</head>
<body>
    <h1>Admin Panel</h1>
    <span id="user-name">Guest</span>
    <form id="logout-form" style="display:inline;">
        <input type="hidden" name="csrf-token" id="csrf-token-logout">
        <button type="submit">Logout</button>
      </form>

    <form id="product-form">
        <h2>Manage Products</h2>
        <input type="hidden" name="csrf-token" id="csrf-token">
        <label for="category">Category:</label>
        <select id="category" name="category" required></select><br>
        <label for="name">Product Name:</label>
        <input type="text" id="name" name="name" required maxlength="255" pattern="[A-Za-z0-9\s\-\.,]+" title="Letters, numbers, spaces, and basic punctuation only"><br>
        <label for="price">Price:</label>
        <input type="number" id="price" name="price" step="0.01" min="0" max="9999.99" required title="Price between 0 and 9999.99"><br>
        <label for="description">Description:</label>
        <textarea id="description" name="description" required maxlength="1000" title="Description up to 1000 characters"></textarea><br>
        <label for="image">Product Image:</label>
        <input type="file" id="image" name="image" accept="image/jpeg, image/png, image/gif"><br>
        <div id="image-error" class="error"></div>
        <button type="submit">Add Product</button>
    </form>

    <form id="category-form">
        <h2>Manage Categories</h2>
        <input type="hidden" name="csrf-token" id="csrf-token-cat">
        <label for="category-name">Category Name:</label>
        <input type="text" id="category-name" name="category-name" required maxlength="255" pattern="[A-Za-z0-9\s\-\.]+" title="Letters, numbers, spaces, hyphen, and dot only"><br>
        <button type="submit">Add Category</button>
    </form>

    <form id="change-password">
        <h2>Change Password</h2>
        <label for="current-password">Current Password:</label>
        <input type="password" id="current-password" required minlength="8" maxlength="50" title="Password must be 8-50 characters"><br>
        <label for="new-password">New Password:</label>
        <input type="password" id="new-password" required minlength="8" maxlength="50" title="Password must be 8-50 characters"><br>
        <button type="submit">Change Password</button>
    </form>

    <h2>Product List</h2>
    <ul id="product-list"></ul>

    <h2>Category List</h2>
    <ul id="category-list"></ul>

    <script nonce="">
        let nonce = '';
        fetch('https://ierg4210.koreacentral.cloudapp.azure.com:443/csrf-token')
            .then(res => res.json())
            .then(data => {
                nonce = data.token;
                document.querySelectorAll('script[nonce=""]').forEach(script => script.nonce = nonce);
            });

        function sanitizeInput(input) {
            return input.replace(/[<>"'%;()&+]/g, '');
        }

        function escapeHtml(unsafe) {
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function loadCategories() {
            fetch('https://ierg4210.koreacentral.cloudapp.azure.com:443/categories')
                .then(response => response.json())
                .then(categories => {
                    const categorySelect = document.getElementById('category');
                    categorySelect.innerHTML = '<option value="">-- Select a Category --</option>';
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.catid;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                });
        }

        function loadProducts() {
            fetch('https://ierg4210.koreacentral.cloudapp.azure.com:443/products')
                .then(response => response.json())
                .then(products => {
                    const productList = document.getElementById('product-list');
                    productList.innerHTML = '';
                    products.forEach(product => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            ${escapeHtml(product.name)} - $${escapeHtml(product.price.toString())}
                            <a href="../product.html?pid=${escapeHtml(product.pid)}" target="_blank">View</a>
                            <button onclick="deleteProduct(${product.pid})">Delete</button>
                            <button onclick="editProduct(${product.pid}, '${escapeHtml(product.name)}', ${product.price}, '${escapeHtml(product.description)}', ${product.catid})">Edit</button>
                        `;
                        productList.appendChild(li);
                    });
                });
        }

        function loadCategoryList() {
            fetch('https://ierg4210.koreacentral.cloudapp.azure.com:443/categories')
                .then(response => response.json())
                .then(categories => {
                    const categoryList = document.getElementById('category-list');
                    categoryList.innerHTML = '';
                    categories.forEach(category => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            ${escapeHtml(category.name)}
                            <button onclick="deleteCategory(${category.catid})">Delete</button>
                            <button onclick="editCategory(${category.catid}, '${escapeHtml(category.name)}')">Edit</button>
                        `;
                        categoryList.appendChild(li);
                    });
                });
        }

        document.getElementById('product-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = sanitizeInput(document.getElementById('name').value);
            const price = document.getElementById('price').value;
            const description = sanitizeInput(document.getElementById('description').value);
            if (!name || isNaN(price) || price < 0 || !description) {
                alert('Invalid input detected');
                return;
            }
            const formData = new FormData(e.target);
            const isUpdate = e.target.dataset.pid;
            const url = isUpdate ? `https://ierg4210.koreacentral.cloudapp.azure.com:443/update-product/${isUpdate}` : 'https://ierg4210.koreacentral.cloudapp.azure.com:443/add-product';
            fetch(url, { method: isUpdate ? 'PUT' : 'POST', body: formData })
                .then(response => response.text())
                .then(message => {
                    alert(message);
                    if (isUpdate) {
                        e.target.innerHTML = e.target.dataset.original;
                        delete e.target.dataset.pid;
                    } else {
                        e.target.reset();
                    }
                    loadProducts();
                });
        });

        document.getElementById('category-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const categoryName = sanitizeInput(document.getElementById('category-name').value);
            if (!categoryName) {
                alert('Invalid category name');
                return;
            }
            const isUpdate = e.target.dataset.catid;
            const url = isUpdate ? `https://ierg4210.koreacentral.cloudapp.azure.com:443/update-category/${isUpdate}` : 'https://ierg4210.koreacentral.cloudapp.azure.com:443/add-category';
            fetch(url, {
                method: isUpdate ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: categoryName })
            })
            .then(response => response.text())
            .then(message => {
                alert(message);
                if (isUpdate) {
                    e.target.innerHTML = e.target.dataset.original;
                    delete e.target.dataset.catid;
                } else {
                    e.target.reset();
                }
                loadCategories();
                loadCategoryList();
            });
        });

        document.getElementById('change-password').addEventListener('submit', (e) => {
            e.preventDefault();
            const current = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            fetch('https://ierg4210.koreacentral.cloudapp.azure.com:443/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current, newPass })
            }).then(() => location.href = 'https://ierg4210.koreacentral.cloudapp.azure.com:443/logout');
        });

        function deleteProduct(pid) {
            if (confirm('Are you sure?')) {
                fetch(`https://ierg4210.koreacentral.cloudapp.azure.com:443/delete-product/${pid}`, { method: 'DELETE' })
                    .then(response => response.text())
                    .then(message => {
                        alert(message);
                        loadProducts();
                    });
            }
        }

        function deleteCategory(catid) {
            if (confirm('Are you sure?')) {
                fetch(`https://ierg4210.koreacentral.cloudapp.azure.com:443/delete-category/${catid}`, { method: 'DELETE' })
                    .then(response => response.text())
                    .then(message => {
                        alert(message);
                        loadCategories();
                        loadCategoryList();
                    });
            }
        }

        function editProduct(pid, name, price, description, catid) {
            const form = document.getElementById('product-form');
            form.innerHTML = `
                <h2>Edit Product</h2>
                <input type="hidden" name="csrf-token" id="csrf-token">
                <label for="category">Category:</label>
                <select id="category" name="category" required></select><br>
                <label for="name">Product Name:</label>
                <input type="text" id="name" name="name" value="${escapeHtml(name)}" required maxlength="255" pattern="[A-Za-z0-9\s\-\.,]+" title="Letters, numbers, spaces, and basic punctuation only"><br>
                <label for="price">Price:</label>
                <input type="number" id="price" name="price" step="0.01" min="0" max="9999.99" value="${price}" required title="Price between 0 and 9999.99"><br>
                <label for="description">Description:</label>
                <textarea id="description" name="description" required maxlength="1000" title="Description up to 1000 characters">${escapeHtml(description)}</textarea><br>
                <label for="image">Product Image:</label>
                <input type="file" id="image" name="image" accept="image/jpeg, image/png, image/gif"><br>
                <div id="image-error" class="error"></div>
                <button type="submit">Update Product</button>
            `;
            form.dataset.pid = pid;
            loadCategories();
            setTimeout(() => document.getElementById('category').value = catid, 100);
        }

        function editCategory(catid, name) {
            const form = document.getElementById('category-form');
            form.innerHTML = `
                <h2>Edit Category</h2>
                <input type="hidden" name="csrf-token" id="csrf-token-cat">
                <label for="category-name">Category Name:</label>
                <input type="text" id="category-name" name="category-name" value="${escapeHtml(name)}" required maxlength="255" pattern="[A-Za-z0-9\s\-\.]+" title="Letters, numbers, spaces, hyphen, and dot only"><br>
                <button type="submit">Update Category</button>
            `;
            form.dataset.catid = catid;
        }

        window.addEventListener('load', () => {
            document.getElementById('product-form').dataset.original = document.getElementById('product-form').innerHTML;
            document.getElementById('category-form').dataset.original = document.getElementById('category-form').innerHTML;
            loadCategories();
            loadProducts();
            loadCategoryList();
            fetch('https://ierg4210.koreacentral.cloudapp.azure.com:443/user')
                .then(res => res.json())
                .then(data => document.getElementById('user-name').textContent = data.email || 'Guest');
            fetch('https://ierg4210.koreacentral.cloudapp.azure.com:443/csrf-token')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('csrf-token').value = data.token;
                    document.getElementById('csrf-token-cat').value = data.token;
                });
        });
    </script>
    <script nonce="">(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'92757d2a9843bfe3',t:'MTc0MzE0NzcyNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>