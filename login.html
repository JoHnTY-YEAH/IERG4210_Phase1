<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-randomNonce'; style-src 'self';">
    <title>Login</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    <h1>Login</h1>
    <form id="login-form">
        <input type="hidden" name="csrfToken" id="csrfToken">
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required><br>
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required><br>
        <button type="submit">Login</button>
    </form>
    <p><a href="/index.html">Back to Home</a></p>

    <script nonce="randomNonce">
        fetch('https://ierg4210.koreacentral.cloudapp.azure.com/csrf-token', { credentials: 'include' })
            .then(res => res.json())
            .then(data => document.getElementById('csrfToken').value = data.csrfToken)
            .catch(err => console.error('CSRF fetch error:', err));

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            fetch('https://ierg4210.koreacentral.cloudapp.azure.com/login', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) throw new Error('Invalid credentials');
                    return response.json();
                })
                .then(data => {
                    if (data.role === 'admin') {
                        window.location.href = '/public/admin.html';
                    } else {
                        window.location.href = '/index.html';
                    }
                })
                .catch(error => {
                    console.error('Login error:', error);
                    alert('Login failed: ' + error.message);
                });
        });
    </script>
</body>
</html>